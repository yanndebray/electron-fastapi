name: Build Desktop App

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write  # needed for creating releases

env:
  PYTHON_VERSION: "3.12.12"
  PYTHON_MINOR: "3.12"  # for stdlib paths like lib/python3.12
  PBS_RELEASE: "20260211"
  NODE_VERSION: "20"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x86_64
            pbs_triple: x86_64-unknown-linux-gnu
            electron_arch: x64
            python_bin: python-runtime/bin/python3

          - os: macos-latest    # Apple Silicon
            target: darwin-aarch64
            pbs_triple: aarch64-apple-darwin
            electron_arch: arm64
            python_bin: python-runtime/bin/python3

          - os: windows-latest
            target: windows-x86_64
            pbs_triple: x86_64-pc-windows-msvc
            electron_arch: x64
            python_bin: python-runtime/python.exe

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.target }})

    steps:
      # ── checkout ───────────────────────────────────────────────
      - uses: actions/checkout@v4

      # ── install uv ────────────────────────────────────────────
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      # ── install Node.js ───────────────────────────────────────
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      # ── download python-build-standalone ──────────────────────
      - name: Download python-build-standalone
        shell: bash
        run: |
          PBS_FILENAME="cpython-${{ env.PYTHON_VERSION }}+${{ env.PBS_RELEASE }}-${{ matrix.pbs_triple }}-install_only_stripped.tar.gz"
          PBS_URL="https://github.com/astral-sh/python-build-standalone/releases/download/${{ env.PBS_RELEASE }}/${PBS_FILENAME}"

          echo "Downloading: $PBS_URL"
          curl -L --fail -o "/tmp/${PBS_FILENAME}" "$PBS_URL"

          mkdir -p build/bundle/python-runtime
          tar -xf "/tmp/${PBS_FILENAME}" -C build/bundle/python-runtime --strip-components=1

      # ── install Python dependencies ───────────────────────────
      - name: Install Python dependencies
        shell: bash
        run: |
          # Use uv to resolve and install deps into a flat site-packages dir
          mkdir -p build/bundle/python-venv/site-packages

          # Generate a locked requirements file from pyproject.toml
          cd backend
          uv pip compile pyproject.toml -o /tmp/requirements.txt
          cd ..

          # Install into the target directory using uv pip
          uv pip install \
            --python "build/bundle/${{ matrix.python_bin }}" \
            -r /tmp/requirements.txt \
            --target build/bundle/python-venv/site-packages

      # ── prune unnecessary files ───────────────────────────────
      - name: Prune bundle
        shell: bash
        run: |
          cd build/bundle
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.pyc" -delete 2>/dev/null || true

          # Remove large unused stdlib modules
          PYLIB="python-runtime/lib/python${{ env.PYTHON_MINOR }}"
          if [ -d "$PYLIB" ]; then
            rm -rf "$PYLIB/tkinter" "$PYLIB/turtle"* "$PYLIB/idlelib" "$PYLIB/ensurepip"
            rm -rf "$PYLIB/site-packages/pip" "$PYLIB/site-packages/setuptools"
          fi

          echo "Bundle size:"
          du -sh python-runtime python-venv .

      # ── make python executable (unix) ─────────────────────────
      - name: Fix permissions
        if: runner.os != 'Windows'
        run: chmod +x "build/bundle/${{ matrix.python_bin }}"

      # ── install Electron deps & build ─────────────────────────
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build Electron app
        working-directory: frontend
        shell: bash
        env:
          # electron-builder code-signing (optional, configure secrets)
          # CSC_LINK: ${{ secrets.MAC_CERTIFICATE }}
          # CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTIFICATE_PASSWORD }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx electron-builder \
            --${{ runner.os == 'Windows' && 'win' || runner.os == 'macOS' && 'mac' || 'linux' }} \
            --${{ matrix.electron_arch }} \
            --publish never

      # ── ad-hoc codesign + rebuild DMG (macOS) ──────────────────
      # Without this, Gatekeeper reports the app as "damaged" because
      # the bundled Python runtime binaries are unsigned, breaking
      # the bundle's sealed-resource checks.
      - name: Ad-hoc codesign and repackage DMG
        if: runner.os == 'macOS'
        working-directory: frontend
        run: |
          APP="../dist/mac-${{ matrix.electron_arch }}/My Desktop App.app"

          # 1. Sign shared libraries and Python extensions (inside-out)
          find "$APP" -type f \( -name "*.dylib" -o -name "*.so" -o -name "*.node" \) \
            -exec codesign --force --sign - {} \;

          # 2. Sign the bundled Python interpreter
          codesign --force --sign - "$APP/Contents/Resources/python-runtime/bin/python3"

          # 3. Sign Electron helper apps (inner bundles before outer)
          find "$APP/Contents/Frameworks" -depth -name "*.app" \
            -exec codesign --force --sign - {} \;

          # 4. Sign all frameworks (Electron, Mantle, ReactiveObjC, Squirrel)
          for fw in "$APP"/Contents/Frameworks/*.framework; do
            codesign --force --sign - "$fw"
          done

          # 5. Sign the main app bundle
          codesign --force --sign - "$APP"

          # Verify
          codesign --verify --deep --strict "$APP"
          echo "Ad-hoc codesign verified OK"

          # 6. Rebuild DMG so it contains the signed app
          rm -f ../dist/*.dmg ../dist/*.blockmap
          npx electron-builder \
            --mac dmg \
            --${{ matrix.electron_arch }} \
            --pd "../dist/mac-${{ matrix.electron_arch }}" \
            --publish never
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: "false"

      # ── upload artifacts ──────────────────────────────────────
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.target }}
          path: |
            dist/*.dmg
            dist/*.exe
            dist/*.AppImage
            dist/*.deb
            dist/*.zip
          if-no-files-found: error

  # ── create GitHub release ───────────────────────────────────
  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          generate_release_notes: true
